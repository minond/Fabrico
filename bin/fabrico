#!/bin/bash

# find root of project
while [ ! -d Fabrico ]; do
	cd "$(pwd)/../"

	if [ "$PWD" == "/" ]; then
		echo "fatal: Not a Fabrico project"
		exit
	fi
done

# the move into fabrico directory
cd Fabrico

tests() {
	./vendor/bin/phpunit
}

documentation() {
	./vendor/bin/apigen.php --source src/ --destination bin/autogen/docs/ --todo
}

benchmark() {
	ab -c 10 -n 2000 http://localhost/Propositum/Users/viewUsers
}

reportsection() {
	echo -e "\n\n---- ${1}:\n" >> bin/autogen/code/report.txt
}

codequality() {
	# reset dir
	mkdir -p bin/autogen/code
	rm bin/autogen/code/*
	date > bin/autogen/code/report.txt

	# tools can be installing via:
	# pear config-set auto_discover 1
	# pear install pear.phpqatools.org/phpqatools
	reportsection "loc (src)"
	phploc src/ | tee bin/autogen/code/loc_src.txt >> bin/autogen/code/report.txt

	reportsection "loc (tests)"
	phploc tests/ | tee bin/autogen/code/loc_tests.txt >> bin/autogen/code/report.txt

	reportsection cpd
	phpcpd src/ | tee bin/autogen/code/cpd.txt >> bin/autogen/code/report.txt

	reportsection "code sniffer"
	phpcs src/ | tee bin/autogen/code/codesniffer.txt >> bin/autogen/code/report.txt
}

view() {
	case "$1" in
		test)
			xdg-open bin/autogen/tests/report/index.html
			;;

		doc)
			xdg-open bin/autogen/code/report.txt
			;;
	esac
}

for arg in "$@"
do
	case "$arg" in
		view)
			view $2
			exit 1
			;;

		test)
			tests
			exit 1
			;;

		doc)
			documentation
			exit 1
			;;

		bench)
			benchmark
			exit 1
			;;

		code)
			codequality
			exit 1
			;;

		build)
			clear
			echo "running tests..."
			tests
			echo "done"
			echo "generating code quality..."
			codequality
			echo "done"
			echo "generating documentation..."
			documentation
			echo "done"
			echo "running basic benchmark..."
			benchmark
			echo "done"
			exit 1
			;;
	esac
done

php ./src/scripts/cli.php
exit 1
