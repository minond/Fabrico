#!/bin/bash

tests() {
	./vendor/bin/phpunit
}

documentation() {
	./vendor/bin/apigen.php --source src/ --destination bin/autogen/docs/ --todo 
}

benchmark() {
	ab -c 10 -n 2000 http://localhost/Propositum/Users/viewUsers
}

reportsection() {
	echo -e "\n\n---- ${1}:\n" >> bin/autogen/code/report.txt
}

codequality() {
	# reset dir
	mkdir -p bin/autogen/code
	rm bin/autogen/code/*
	date > bin/autogen/code/report.txt

	# tools can be installing via:
	# pear config-set auto_discover 1
	# pear install pear.phpqatools.org/phpqatools
	reportsection loc
	phploc src/ | tee bin/autogen/code/loc.txt >> bin/autogen/code/report.txt

	reportsection cpd
	phpcpd src/ | tee bin/autogen/code/cpd.txt >> bin/autogen/code/report.txt

	reportsection "code sniffer"
	phpcs src/ | tee bin/autogen/code/codesniffer.txt >> bin/autogen/code/report.txt
}

for arg in "$@"
do
	case "$arg" in
		test)
			tests
			;;
		doc)
			documentation
			;;
		bench)
			benchmark
			;;
		code)
			codequality
			;;
		build)
			clear
			echo "running tests..."
			tests
			echo "done"
			echo "generating code quality..."
			codequality
			echo "done"
			echo "generating documentation..."
			documentation
			echo "done"
			echo "running basic benchmark..."
			benchmark
			echo "done"
			;;
		--)
			exit 1
	esac
done
